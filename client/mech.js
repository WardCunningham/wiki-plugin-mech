/* wiki-plugin-mech - 0.1.30 - Sat, 15 Mar 2025 18:05:36 GMT */
(()=>{function d(e,i){e.innerText.match(/✖︎/)||(e.innerHTML+='<button style="border-width:0;color:red;">\u2716\uFE0E</button>',e.querySelector("button").addEventListener("click",s=>{e.outerHTML+=`<span style="width:80%;color:gray;">${i}</span>`}))}function m(e,i,s){let t=e.previousElementSibling;if(s.debug){let n=s[i];t.innerHTML=`${i} \u21D2 `,t.addEventListener("click",o=>{console.log({key:i,value:n});let c=t.previousElementSibling;if(!c?.classList.contains("look")){let f=document.createElement("div");f.classList.add("look"),t.insertAdjacentElement("beforebegin",f),c=t.previousElementSibling}let a=JSON.stringify(n,null,1);a.length>300&&(a=a.substring(0,400)+"...");let r="border:1px solid black; background-color:#f8f8f8; padding:8px; color:gray; word-break: break-all;";c.innerHTML=`<div style="${r}">${a}</div>`})}else t.innerHTML=""}function M({elem:e,body:i,state:s}){if(!e.innerHTML.match(/button/)){if(!i?.length)return d(e,"CLICK expects indented blocks to follow.");e.innerHTML+='<button style="border-width:0;">\u25B6</button>',e.querySelector("button").addEventListener("click",t=>{s.debug=t.shiftKey,run(i,s)})}}function v({elem:e,args:i,state:s}){let t=i[0]=="world"?" \u{1F30E}":" \u{1F600}";for(let n of Object.keys(s))m(e,n,s);e.innerHTML+=t}function H({elem:e,args:i,body:s,state:t}){let n=e.innerHTML,o=i[0];e.innerHTML=n+" \u23F3",fetch(`//${o}.json`).then(c=>c.json()).then(c=>{t.page=c,e.innerHTML=n+" \u231B",run(s,t)})}function O({elem:e,args:i,body:s,state:t}){let n=e.innerHTML.replaceAll(/ ⌛/g,"");if(!("page"in t))return d(e,'Expect "page" as with FROM.');m(e,"page",t);let o=t.page.story.find(l=>l.type=="datalog");if(!o)return d(e,"Expect Datalog plugin in the page.");let c=i[0];if(!c)return d(e,"SENSOR needs a sensor name.");let a=o.text.split(/\n/).map(l=>l.split(/ +/)).filter(l=>l[0]=="SENSOR").find(l=>l[1]==c);if(!a)return d(e,`Expect to find "${c}" in Datalog.`);let r=a[2],f=l=>9/5*(l/16)+32,u=l=>l.reduce((g,h)=>g+h,0)/l.length;e.innerHTML=n+" \u23F3",fetch(r).then(l=>l.json()).then(l=>{t.debug&&console.log({sensor:a,data:l}),e.innerHTML=n+" \u231B";let g=f(u(Object.values(l)));t.temperature=`${g.toFixed(2)}\xB0F`,run(s,t)})}function I({elem:e,command:i,state:s}){let t=s?.temperature;if(!t)return d(e,"Expect data, as from SENSOR.");m(e,"temperature",s),e.innerHTML=i+`<br><font face=Arial size=32>${t}</font>`}function R({elem:e,command:i,args:s,body:t,state:n}){if(!(s&&s.length))return d(e,'Expected Source topic, like "markers" for Map markers.');let o=s[0],c=e.closest(".item"),a=requestSourceData(c,o);if(!a.length)return d(e,`Expected source for "${o}" in the lineup.`);let r=u=>{let l=a.filter(g=>[...g.div.classList].includes(u)).length;return l?`${l} ${u}`:null},f=[r("map"),r("image"),r("frame"),r("assets")].filter(u=>u).join(", ");n.debug&&console.log({topic:o,sources:a}),e.innerHTML=i+" \u21D2 "+f,n[o]=a.map(({div:u,result:l})=>({id:u.dataset.id,result:l})),t&&run(t,n)}function j({elem:e,command:i,args:s,state:t}){let n=g=>(+g).toFixed(7),o=[],c=s;for(let g of c)switch(g){case"map":if(!("marker"in t))return d(e,'"map" preview expects "marker" state, like from "SOURCE marker".');m(e,"marker",t);let h=t.marker.map(p=>[p.result]).flat(2).map(p=>`${n(p.lat)}, ${n(p.lon)} ${p.label||""}`).filter(uniq).join(`
`);o.push({type:"map",text:h});break;case"graph":if(!("aspect"in t))return d(e,'"graph" preview expects "aspect" state, like from "SOURCE aspect".');m(e,"aspect",t);for(let{div:p,result:b}of t.aspect){for(let{name:w,graph:k}of b)t.debug&&console.log({div:p,result:b,name:w,graph:k}),o.push({type:"paragraph",text:w}),o.push({type:"graphviz",text:dotify(k)});o.push({type:"pagefold",text:"."})}break;case"items":if(!("items"in t))return d(e,'"graph" preview expects "items" state, like from "KWIC".');m(e,"items",t),o.push(...t.items);break;case"page":if(!("page"in t))return d(e,'"page" preview expects "page" state, like from "FROM".');m(e,"page",t),o.push(...t.page.story);break;case"synopsis":{let p=`This page created with Mech command: "${i}". See [[${t.context.title}]].`;o.push({type:"paragraph",text:p,id:t.context.itemId})}break;default:return d(e,`"${g}" doesn't name an item we can preview`)}let r={title:"Mech Preview"+(t.tick?` ${t.tick}`:""),story:o};for(let g of r.story)g.id||=(Math.random()*10**20).toFixed(0);let f=JSON.parse(JSON.stringify(r)),u=Date.now();r.journal=[{type:"create",date:u,item:f}];let l={$page:$(e.closest(".page"))};wiki.showResult(wiki.newPage(r),l)}async function A({elem:e,command:i,args:s,body:t,state:n}){let o=r=>document.getElementById(r.key),c=s[0];n.debug&&console.log({neighborhoodObject:wiki.neighborhoodObject});let a=Object.entries(wiki.neighborhoodObject.sites).filter(([r,f])=>!f.sitemapRequestInflight&&(!c||r.includes(c))).map(([r,f])=>(f.sitemap||[]).map(u=>Object.assign({domain:r},u)));for(let r of t||[]){if(!r.command.endsWith(" Survey")){d(o(r),"NEIGHBORS expects a Site Survey title, like Pattern Link Survey");continue}let f=a.filter(u=>u.find(l=>l.title==r.command));o(r).innerHTML=`${r.command} \u21D2 ${f.length} sites`;for(let u of f){let l=`//${u[0].domain}/${asSlug(r.command)}.json`,g=await fetch(l).then(p=>p.json()),h=g.story.find(p=>p.type=="frame")?.survey;for(let p of u){let b=Object.assign({},h.find(w=>w.slug==p.slug),p);Object.assign(p,b)}console.log({url:l,page:g,survey:h,todo:u})}}n.neighborhood=a.flat().sort((r,f)=>f.date-r.date),e.innerHTML=i+` \u21D2 ${n.neighborhood.length} pages, ${a.length} sites`}function N({elem:e,command:i,args:s,state:t}){if(!("neighborhood"in t))return d(e,"WALK expects state.neighborhood, like from NEIGHBORS.");m(e,"neighborhood",t);let[,n,o]=i.match(/\b(\d+)? *(steps|days|weeks|months|hubs|lineup|references)\b/)||[];if(!o&&i!="WALK")return d(e,"WALK can't understand rest of this block.");let c={lineup(){let l=[...document.querySelectorAll(".page")],g=l.indexOf(e.closest(".page"));return l.slice(0,g)},references(){let l=e.closest(".page"),g=wiki.lineup.atKey(l.dataset.key),h=g.getRawPage().story;return console.log({div:l,pageObject:g,story:h}),h.filter(p=>p.type=="reference")}},a=walks(n,o,t.neighborhood,c),r=a.filter(({graph:l})=>l);t.debug&&console.log({steps:a}),e.innerHTML=i;let f=r.map(({graph:l})=>l.nodes).flat();e.innerHTML+=` \u21D2 ${r.length} aspects, ${f.length} nodes`,a.find(({graph:l})=>!l)&&d(e,"WALK skipped sites with no links in sitemaps");let u=e.closest(".item");if(r.length){t.aspect=t.aspect||[];let l=t.aspect.find(g=>g.id==e.id);l?l.result=r:t.aspect.push({id:e.id,result:r,source:i}),u.classList.add("aspect-source"),u.aspectData=()=>t.aspect.map(g=>g.result).flat(),t.debug&&console.log({command:i,state:t.aspect,item:u.aspectData()})}}function K({elem:e,command:i,args:s,body:t,state:n}){if(e.innerHTML.match(/button/))return;if(!t?.length)return d(e,"TICK expects indented blocks to follow.");let o=s[0]||"1";if(!o.match(/^[1-9][0-9]?$/))return d(e,"TICK expects a count from 1 to 99");let c=null;a();function a(){e.innerHTML=i+'<button style="border-width:0;">\u25B6</button>',e.querySelector("button").addEventListener("click",r)}function r(f){n.debug=f.shiftKey;let u=l=>{e.innerHTML=i+` \u21D2 ${l} remaining`};if(c)c=clearInterval(c),delete n.tick;else{let l;n.tick=+o,u(n.tick),l=!0,run(t,n).then(()=>l=!1),c=setInterval(()=>{l||(n.debug&&console.log({tick:n.tick}),"tick"in n&&--n.tick>0?(u(n.tick),l=!0,run(t,n).then(()=>l=!1)):(c=clearInterval(c),a()))},1e3)}}}function _({elem:e,command:i,args:s,body:t,state:n}){if(!s.length)return d(e,"UNTIL expects an argument, a word to stop running.");if(!n.tick)return d(e,"UNTIL expects to indented below an iterator, like TICKS.");if(!n.aspect)return d(e,'UNTIL expects "aspect", like from WALK.');m(e,"aspect",n),e.innerHTML=i+` \u21D2 ${n.tick}`;let o=s[0];for(let{div:c,result:a}of n.aspect)for(let{name:r,graph:f}of a)for(let u of f.nodes)if(u.type.includes(o)||u.props.name.includes(o)){n.debug&&console.log({div:c,result:a,name:r,graph:f,node:u}),delete n.tick,e.innerHTML+=" done",t&&run(t,n);return}}function W({elem:e,command:i,args:s,state:t}){if(s.length<1)return d(e,'FORWARD expects an argument, the number of steps to move a "turtle".');"turtle"in t||(t.turtle=new Turtle(e));let n=s[0],o=t.turtle.forward(+n);e.innerHTML=i+` \u21D2 ${o.map(c=>(c-200).toFixed(1)).join(", ")}`}function D({elem:e,command:i,args:s,state:t}){if(s.length<1)return d(e,'TURN expects an argument, the number of degrees to turn a "turtle".');"turtle"in t||(t.turtle=new Turtle(e));let n=s[0],o=t.turtle.turn(+n);e.innerHTML=i+` \u21D2 ${o}\xB0`}function C({elem:e,command:i,args:s,body:t,state:n}){if(!("assets"in n))return d(e,"FILE expects state.assets, like from SOURCE assets.");m(e,"assets",n);let o="//"+window.location.host,c=n.assets.map(({id:u,result:l})=>Object.entries(l).map(([g,h])=>Object.entries(h).map(([p,b])=>b.map(w=>{let k=p.startsWith("//")?p:`${o}${p}`,E=k.replace(/\/assets$/,""),S=`${k}/${g}/${w}`;return{id:u,dir:g,path:p,host:E,file:w,url:S}})))).flat(3);if(n.debug&&console.log({assets:c}),s.length<1)return d(e,"FILE expects an argument, the dot suffix for desired files.");if(!t?.length)return d(e,"FILE expects indented blocks to follow.");let a=s[0],r=c.filter(u=>u.file.endsWith(a)),f=u=>`<img width=12 src=${r[u].host+"/favicon.png"}>`;if(!r)return d(e,`FILE expects to find an asset with "${a}" suffix.`);e.innerHTML=i+`<br><div class=choices style="border:1px solid black; background-color:#f8f8f8; padding:8px;" >${r.map((u,l)=>`<span data-choice=${l} style="cursor:pointer;">
            ${f(l)}
            ${u.file} \u25B6
          </span>`).join(`<br>
`)}</div>`,e.querySelector(".choices").addEventListener("click",u=>{if(!("choice"in u.target.dataset))return;let l=r[u.target.dataset.choice].url;fetch(l).then(g=>g.text()).then(g=>{e.innerHTML=i+` \u21D2 ${g.length} bytes`,n.tsv=g,console.log({text:g}),run(t,n)})})}function F({elem:e,command:i,args:s,body:t,state:n}){let o=t&&t[0]?.command;if(o&&!o.match(/\$[KW]/))return d(e,"KWIK expects $K or $W in link prototype.");if(!("tsv"in n))return d(e,"KWIC expects a .tsv file, like from ASSETS .tsv.");m(e,"tsv",n);let c=s[0]||1,a=n.tsv.trim().split(/\n/),r=new Set(["of","and","in","at"]),f=$(e.closest(".page")).data("data"),u=f.story.findIndex(h=>h.type=="pagefold"&&h.text=="stop");if(u>=0){let h=f.story.findIndex((p,b)=>b>u&&p.type=="pagefold");f.story.slice(u+1,h).map(p=>p.text.trim().split(/\s+/)).flat().forEach(p=>r.add(p))}let l=kwic(c,a,r);e.innerHTML=i+` \u21D2 ${a.length} lines, ${l.length} groups`;let g=h=>{let p=h.line;if(o){let b=o.replaceAll(/\$K\+/g,h.key.replaceAll(/ /g,"+")).replaceAll(/\$K/g,h.key).replaceAll(/\$W/g,h.word),w=o.match(/\$W/)?h.word:h.key;p=p.replace(w,b)}return p};n.items=l.map(h=>(text=`# ${h.group}

${h.quotes.map(p=>g(p)).join(`
`)}`,{type:"markdown",text}))}function P({elem:e,command:i,args:s,state:t}){e.innerHTML=i;let n,o;if(s.length<1)if(t.info)m(e,"info",t),n=t.info.domain,o=t.info.slug,e.innerHTML=i+` \u21D2 ${t.info.title}`;else return d(e,"SHOW expects a slug or site/slug to open in the lineup.");else{let r=s[0];[n,o]=r.includes("/")?r.split(/\//):[null,r]}if([...document.querySelectorAll(".page")].map(r=>r.id).includes(o))return d(e,"SHOW expects a page not already in the lineup.");let a=e.closest(".page");wiki.doInternalLink(o,a,n)}function U({elem:e,command:i,state:s}){if(!s.neighborhood)return d(e,"RANDOM expected a neighborhood, like from NEIGHBORS.");m(e,"neighborhood",s);let t=s.neighborhood,n=t.length,o=Math.floor(Math.random()*n);e.innerHTML=i+` \u21D2 ${o} of ${n}`,s.info=t[o]}function G({elem:e,command:i,args:s,body:t,state:n}){let o=s[0]||"1";return o.match(/^[1-9][0-9]?$/)?new Promise(c=>{t&&run(t,n).then(r=>{n.debug&&console.log(i,"children",r)}),e.innerHTML=i+` \u21D2 ${o} remain`;let a=setInterval(()=>{--o>0?e.innerHTML=i+` \u21D2 ${o} remain`:(clearInterval(a),e.innerHTML=i+" \u21D2 done",n.debug&&console.log(i,"done"),c())},1e3)}):d(e,"SLEEP expects seconds from 1 to 99")}function q({elem:e,command:i,args:s,body:t,state:n}){if(!t)return d(e,"TOGETHER expects indented commands to run together.");let o=t.map(c=>run([c],n));return Promise.all(o)}async function B({elem:e,command:i,args:s,body:t,state:n}){if(!t)return d(e,"GET expects indented commands to run on the server.");let o={},c=n.context.site;if(s.length)for(let p of s)if(p in n)m(e,p,n),o[p]=n[p];else if(p.match(/\./))c=p;else return d(e,`GET expected "${p}" to name state or site.`);let a=n.context.slug,r=n.context.itemId,f=`mech=${btoa(JSON.stringify(t))}&state=${btoa(JSON.stringify(o))}`,u=`//${c}/plugin/mech/run/${a}/${r}?${f}`;e.innerHTML=i+" \u21D2 in progress";let l=Date.now(),g;try{if(g=await fetch(u).then(p=>p.ok?p.json():p.status),"err"in g)return d(e,`RUN received error "${g.err}"`)}catch(p){return d(e,`RUN failed with "${p.message}"`)}n.result=g;for(let p of g.mech.flat(9)){let b=document.getElementById(p.key);"status"in p&&(b.innerHTML=p.command+` \u21D2 ${p.status}`),"trouble"in p&&d(b,p.trouble)}"debug"in g.state&&delete g.state.debug,Object.assign(n,g.state);let h=((Date.now()-l)/1e3).toFixed(3);e.innerHTML=i+` \u21D2 ${h} seconds`}function J({elem:e,command:i,args:s,body:t,state:n}){let o=a=>JSON.parse(JSON.stringify(a)),c=a=>JSON.stringify(a).length;if(s.length<1)return d(e,'DELTA expects argument, "have" or "apply" on client.');if(t)return d(e,"DELTA doesn't expect indented input.");switch(s[0]){case"have":let a=n.context.page.journal.filter(l=>l.type!="fork");n.recent=a[a.length-1].date,e.innerHTML=i+` \u21D2 ${new Date(n.recent).toLocaleString()}`;break;case"apply":if(!("actions"in n))return d(e,'DELTA apply expect "actions" as input.');m(e,"actions",n);let r=o(n.context.page),f=c(r);for(let l of n.actions)apply(r,l);n.page=r;let u=c(r);e.innerHTML=i+` \u21D2 \u2206 ${((u-f)/f*100).toFixed(1)}%`;break;default:d(e,`DELTA doesn't know "${s[0]}".`)}}function z({elem:e,command:i,state:s}){if(!s.neighborhood)return d(e,"ROSTER expected a neighborhood, like from NEIGHBORS.");m(e,"neighborhood",s);let t=s.neighborhood,n=t.map(a=>a.domain).filter(uniq),o=a=>a[Math.floor(Math.random()*a.length)];s.debug&&console.log(t);let c=[{type:"roster",text:`Mech
`+n.join(`
`)},{type:"activity",text:`ROSTER Mech
SINCE 30 days`}];e.innerHTML=i+` \u21D2 ${n.length} sites`,s.items=c}function Z({elem:e,command:i,state:s}){let t=[...document.querySelectorAll(".page")].map(n=>{let o=$(n),c=o.data("data"),a=o.data("site")||location.host,r=o.attr("id").split("_")[0],f=c.title||"Empty",u=c.story[0]?.text||"empty";return{type:"reference",site:a,slug:r,title:f,text:u}});e.innerHTML=i+` \u21D2 ${t.length} pages`,s.items=t}function V({elem:e,command:i,args:s,state:t}){if(s.length<1)return d(e,"LISTEN expects argument, an action.");let n=s[0],o=Date.now(),c=0,a=r;a.action="publishSourceData",a.id=e.id,window.addEventListener("message",r),$(".main").on("thumb",(f,u)=>console.log("jquery",{evt:f,thumb:u})),e.innerHTML=i+" \u21D2 ready";function r(f){console.log({event:f});let{data:u}=f;if(u.action=="publishSourceData"&&(u.name==n||u.topic==n))if(c++,a.count=c,t.debug&&console.log({count:c,data:u}),c<=100){let l=Date.now(),g=l-o;o=l,e.innerHTML=i+` \u21D2 ${c} events, ${g} ms`}else window.removeEventListener("message",r)}}function Q({elem:e,command:i,args:s,state:t}){if(s.length<1)return d(e,"MESSAGE expects argument, an action.");let n=s[0],o={action:"publishSourceData",topic:n,name:n};window.postMessage(o,"*"),e.innerHTML=i+" \u21D2 sent"}async function X({elem:e,command:i,state:s}){if(!("aspect"in s))return d(e,'"SOLO" expects "aspect" state, like from "WALK".');m(e,"aspect",s),e.innerHTML=i;let t=s.aspect.map(r=>({source:r.source||r.id,aspects:r.result})),n=t.reduce((r,f)=>r+f.aspects.length,0);e.innerHTML+=` \u21D2 ${t.length} sources, ${n} aspects`;let o=e.closest(".page").dataset.key,c={type:"batch",sources:t,pageKey:o};console.log({pageKey:o,doing:c}),(typeof window.soloListener>"u"||window.soloListener==null)&&(console.log("**** Adding solo listener"),window.soloListener=soloListener,window.addEventListener("message",soloListener)),await delay(750);let a=window.open("/plugins/solo/dialog/#","solo","popup,height=720,width=1280");a.location.pathname!="/plugins/solo/dialog/"?(console.log("launching new dialog"),a.addEventListener("load",r=>{console.log("launched and loaded"),a.postMessage(c,window.origin)})):(console.log("reusing existing dialog"),a.postMessage(c,window.origin))}var y={CLICK:{emit:M},HELLO:{emit:v},FROM:{emit:H},SENSOR:{emit:O},REPORT:{emit:I},SOURCE:{emit:R},PREVIEW:{emit:j},NEIGHBORS:{emit:A},WALK:{emit:N},TICK:{emit:K},UNTIL:{emit:_},FORWARD:{emit:W},TURN:{emit:D},FILE:{emit:C},KWIC:{emit:F},SHOW:{emit:P},RANDOM:{emit:U},SLEEP:{emit:G},TOGETHER:{emit:q},GET:{emit:B},DELTA:{emit:J},ROSTER:{emit:z},LINEUP:{emit:Z},LISTEN:{emit:V},MESSAGE:{emit:Q},SOLO:{emit:X}};function Y(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function L(e,i,s){for(;e.length;){let n=e[0].match(/( *)(.*)/),o=n[1].length,c=n[2];if(o==s)i.push({command:c}),e.shift();else if(o>s){var t=[];i.push(t),L(e,t,o)}else return i}return i}function x(e){let i=Math.floor(Math.random()*1e6),s=(t,n)=>{let o=[];for(let c of t){let a=`${i}.${n.join(".")}`;c.key=a,"command"in c?o.push(`<font color=gray size=small></font><span style="display: block;" id=${a}>${Y(c.command)}</span>`):o.push(`<div id=${a} style="padding-left:15px">${s(c,[...n,0])}</div>`),n[n.length-1]++}return o.join(`
`)};return s(e,[0])}async function T(e,i={},s){let t=e.slice();for(;t.length;){let n=t.shift();if("command"in n){let o=n.command,c=s||document.getElementById(n.key),[a,...r]=n.command.split(/ +/),f=t[0],u=f&&"command"in f?null:t.shift(),l={command:o,op:a,args:r,body:u,elem:c,state:i};i.debug&&console.log(l),y[a]?await y[a].emit.apply(null,[l]):a.match(/^[A-Z]+$/)?d(c,`${a} doesn't name a block we know.`):n.command.match(/\S/)&&d(c,"Expected line to begin with all-caps keyword.")}}}function ce(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function ee(e,i){let s=i.text.split(/\n/),t=L(s,[],0),n=x(t),o=e.parents(".page"),c=o.data("key"),r={context:{item:i,itemId:i.id,pageKey:c,page:wiki.lineup.atKey(c).getRawPage(),origin:window.origin,site:o.data("site")||window.location.host,slug:o.attr("id"),title:o.data("data").title}};e.append(`<div style="background-color:#eee;padding:15px;border-top:8px;">${n}</div>`),T(t,r)}function te(e,i){return e.dblclick(()=>wiki.textEditor(e,i))}typeof window<"u"&&window!==null&&(window.plugins.mech={emit:ee,bind:te});})();
//# sourceMappingURL=mech.js.map
